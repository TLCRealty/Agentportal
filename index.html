<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open House Portal - TLC Realty</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const API_URL = 'https://script.google.com/macros/s/AKfycbyBKjHyN0GT6k4bNKzW2zk8Q1aSSyrkW_GOjDlE4IINSP4xnk2Z_GGxxAd2jPBC5WI/exec';

        function OpenHouseScheduler() {
          const [view, setView] = useState('agent');
          const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
          const [adminPassword, setAdminPassword] = useState('');
          const ADMIN_PASSWORD = 'TLC2172$$';
          
          const [properties, setProperties] = useState([]);
          const [bookings, setBookings] = useState([]);
          const [loading, setLoading] = useState(true);
          const [newProperty, setNewProperty] = useState({ address: '', weekOf: '' });
          const [showBookingForm, setShowBookingForm] = useState(false);
          const [selectedProperty, setSelectedProperty] = useState(null);
          const [newBooking, setNewBooking] = useState({
            agentName: '',
            phone: '',
            date: '',
            startTime: '',
            endTime: ''
          });

          useEffect(() => {
            loadData();
          }, []);

          const loadData = async () => {
            setLoading(true);
            try {
              const [propsRes, bookingsRes] = await Promise.all([
                fetch(`${API_URL}?action=getProperties`),
                fetch(`${API_URL}?action=getBookings`)
              ]);
              
              const propsData = await propsRes.json();
              const bookingsData = await bookingsRes.json();
              
              setProperties(propsData.properties || []);
              setBookings(bookingsData.bookings || []);
            } catch (error) {
              console.error('Error loading data:', error);
              alert('Error loading data. Please refresh the page.');
            }
            setLoading(false);
          };

          const formatDate = (dateStr) => {
            if (!dateStr) return '';
            let date;
            if (dateStr.includes('T')) {
              date = new Date(dateStr);
            } else {
              date = new Date(dateStr + 'T12:00:00');
            }
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
          };

          const formatTime = (timeStr) => {
            if (!timeStr) return '';
            let date;
            if (timeStr.includes('T')) {
              date = new Date(timeStr);
            } else {
              const [hours, minutes] = timeStr.split(':');
              date = new Date();
              date.setHours(parseInt(hours), parseInt(minutes));
            }
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          };

          const getWeekRange = (weekOfDate) => {
            // Handle both string formats from API
            let dateStr = weekOfDate;
            if (dateStr.includes('T')) {
              dateStr = dateStr.split('T')[0];
            }
            const date = new Date(dateStr + 'T12:00:00');
            const day = date.getDay();
            const diff = day === 0 ? -6 : 1 - day;
            const monday = new Date(date);
            monday.setDate(date.getDate() + diff);
            monday.setHours(0, 0, 0, 0);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            
            return { start: monday, end: sunday };
          };

          const getActiveProperties = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return properties.filter(prop => {
              const weekRange = getWeekRange(prop.weekOf);
              return weekRange.end >= today;
            }).sort((a, b) => new Date(a.weekOf) - new Date(b.weekOf));
          };

          const getBookingForProperty = (address, weekOf) => {
            return bookings.find(b => b.propertyAddress === address && b.weekOf === weekOf);
          };

          const formatWeekRange = (weekOfDate) => {
            const range = getWeekRange(weekOfDate);
            const start = range.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const end = range.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            return `${start} - ${end}`;
          };

          const handleAdminLogin = () => {
            if (adminPassword === ADMIN_PASSWORD) {
              setIsAdminAuthenticated(true);
              setAdminPassword('');
            } else {
              alert('Incorrect password');
              setAdminPassword('');
            }
          };

          const handleAdminLogout = () => {
            setIsAdminAuthenticated(false);
            setView('agent');
          };

          const handleAddProperty = async () => {
            if (!newProperty.address || !newProperty.weekOf) {
              alert('Please fill in all fields');
              return;
            }

            const date = new Date(newProperty.weekOf + 'T00:00:00');
            if (date.getDay() !== 1) {
              alert('Please select a Monday for the "Week Of" date');
              return;
            }

            const propertyData = {
              address: newProperty.address,
              weekOf: newProperty.weekOf
            };

            try {
              await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'addProperty', ...propertyData })
              });
              
              await loadData();
              setNewProperty({ address: '', weekOf: '' });
              alert('Property added successfully!');
            } catch (error) {
              console.error('Error adding property:', error);
              alert('Error adding property. Please try again.');
            }
          };

          const handleDeleteProperty = async (address, weekOf) => {
            if (!confirm('Delete this property? All bookings will be removed.')) return;

            try {
              await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'deleteProperty', address: address, weekOf: weekOf })
              });
              
              await loadData();
            } catch (error) {
              console.error('Error deleting property:', error);
              alert('Error deleting property. Please try again.');
            }
          };

          const handleStartBooking = (property) => {
            setSelectedProperty(property);
            setShowBookingForm(true);
          };

          const handleSubmitBooking = async () => {
            if (!newBooking.agentName || !newBooking.phone || !newBooking.date || 
                !newBooking.startTime || !newBooking.endTime) {
              alert('Please fill in all fields');
              return;
            }

            const bookingDate = new Date(newBooking.date);
            const weekRange = getWeekRange(selectedProperty.weekOf);
            
            if (bookingDate < weekRange.start || bookingDate > weekRange.end) {
              alert(`Please select a date within the week of ${formatWeekRange(selectedProperty.weekOf)}`);
              return;
            }

            const bookingData = {
              propertyAddress: selectedProperty.address,
              weekOf: selectedProperty.weekOf,
              agentName: newBooking.agentName,
              phone: newBooking.phone,
              date: newBooking.date,
              startTime: newBooking.startTime,
              endTime: newBooking.endTime
            };

            try {
              await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'addBooking', ...bookingData })
              });
              
              await loadData();
              setNewBooking({ agentName: '', phone: '', date: '', startTime: '', endTime: '' });
              setShowBookingForm(false);
              setSelectedProperty(null);
              alert('Open house booked successfully!');
            } catch (error) {
              console.error('Error booking:', error);
              alert('Error booking. Please try again.');
            }
          };

          const handleCancelBooking = async (address, weekOf) => {
            if (!confirm('Cancel this booking?')) return;

            try {
              await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'deleteBooking', propertyAddress: address, weekOf: weekOf })
              });
              
              await loadData();
            } catch (error) {
              console.error('Error canceling booking:', error);
              alert('Error canceling booking. Please try again.');
            }
          };

          const exportSchedule = () => {
            let csv = 'Property Address,Week Of,Agent Name,Phone,Date,Day of Week,Time\n';
            bookings.forEach(b => {
              const dayOfWeek = new Date(b.date).toLocaleDateString('en-US', { weekday: 'long' });
              csv += `"${b.propertyAddress}","${formatWeekRange(b.weekOf)}","${b.agentName}","${b.phone}","${b.date}","${dayOfWeek}","${b.startTime} - ${b.endTime}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'open-house-schedule.csv';
            a.click();
          };

          const activeProperties = getActiveProperties();

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 p-6 flex items-center justify-center">
                <div className="text-center">
                  <div className="animate-spin mx-auto mb-4 text-blue-900 text-5xl">âŸ³</div>
                  <p className="text-gray-600 font-medium">Loading...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 p-6">
              <div className="max-w-6xl mx-auto">
                <div className="bg-white rounded-xl shadow-xl p-8 mb-6 border-t-4 border-blue-900">
                  <div className="flex justify-between items-center mb-6">
                    <div className="flex items-center gap-4">
                      <img 
                        src="https://www.dropbox.com/scl/fi/smxwkgt9hrs7v5jg3qceu/TLC-Realty-Group-Logos-12026-lockup.png?rlkey=qxy1lsk5lvfeo5ohb5rqgvrrz&st=e5gqx5kp&raw=1" 
                        alt="TLC Realty Logo" 
                        className="h-16 object-contain"
                      />
                      <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-900 to-blue-700 bg-clip-text text-transparent">
                        Open House Portal
                      </h1>
                    </div>
                    <button
                      onClick={exportSchedule}
                      className="flex items-center gap-2 bg-emerald-600 text-white px-5 py-2.5 rounded-lg hover:bg-emerald-700 transition shadow-md"
                    >
                      ðŸ“¥ Export
                    </button>
                  </div>
                  
                  <div className="flex gap-4">
                    <button
                      onClick={() => setView('agent')}
                      className={`px-8 py-3 rounded-lg font-semibold transition shadow-md ${
                        view === 'agent' ? 'bg-blue-900 text-white' : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      Agent View
                    </button>
                    <button
                      onClick={() => setView('admin')}
                      className={`px-8 py-3 rounded-lg font-semibold transition shadow-md ${
                        view === 'admin' ? 'bg-blue-900 text-white' : 'bg-gray-100 text-gray-700'
                      }`}
                    >
                      Admin View
                    </button>
                    {isAdminAuthenticated && view === 'admin' && (
                      <button onClick={handleAdminLogout} className="px-6 py-3 rounded-lg font-semibold bg-red-600 text-white">
                        Logout
                      </button>
                    )}
                  </div>
                </div>

                {view === 'agent' && (
                  <div>
                    {showBookingForm ? (
                      <div className="bg-white rounded-xl shadow-xl p-8">
                        <div className="flex justify-between items-center mb-6">
                          <h2 className="text-2xl font-bold">Reserve Open House</h2>
                          <button onClick={() => setShowBookingForm(false)} className="text-2xl">âœ•</button>
                        </div>
                        <p className="mb-4">{selectedProperty.address} â€¢ {formatWeekRange(selectedProperty.weekOf)}</p>
                        
                        <div className="space-y-4">
                          <input
                            type="text"
                            placeholder="Your Name"
                            value={newBooking.agentName}
                            onChange={(e) => setNewBooking({...newBooking, agentName: e.target.value})}
                            className="w-full px-4 py-3 border-2 rounded-lg"
                          />
                          <input
                            type="tel"
                            placeholder="Phone Number"
                            value={newBooking.phone}
                            onChange={(e) => setNewBooking({...newBooking, phone: e.target.value})}
                            className="w-full px-4 py-3 border-2 rounded-lg"
                          />
                          <input
                            type="date"
                            value={newBooking.date}
                            onChange={(e) => setNewBooking({...newBooking, date: e.target.value})}
                            className="w-full px-4 py-3 border-2 rounded-lg"
                          />
                          <div className="grid grid-cols-2 gap-4">
                            <input
                              type="time"
                              value={newBooking.startTime}
                              onChange={(e) => setNewBooking({...newBooking, startTime: e.target.value})}
                              className="w-full px-4 py-3 border-2 rounded-lg"
                            />
                            <input
                              type="time"
                              value={newBooking.endTime}
                              onChange={(e) => setNewBooking({...newBooking, endTime: e.target.value})}
                              className="w-full px-4 py-3 border-2 rounded-lg"
                            />
                          </div>
                          <button onClick={handleSubmitBooking} className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold">
                            Confirm Reservation
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div>
                        <h2 className="text-3xl font-bold mb-6">Available Open Houses</h2>
                        {activeProperties.length === 0 ? (
                          <div className="bg-white rounded-xl shadow-lg p-12 text-center">
                            <p className="text-gray-500">No properties available</p>
                          </div>
                        ) : (
                          <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                            {activeProperties.map((prop, idx) => {
                              const booking = getBookingForProperty(prop.address, prop.weekOf);
                              const isBooked = !!booking;
                              
                              return (
                                <div key={idx} className="bg-white rounded-xl shadow-lg p-6 border-2 relative">
                                  <div className="absolute top-4 right-4">
                                    <span className={`px-4 py-2 rounded-lg font-bold text-white ${isBooked ? 'bg-red-500' : 'bg-green-500'}`}>
                                      {isBooked ? 'BOOKED' : 'AVAILABLE'}
                                    </span>
                                  </div>
                                  <h3 className="text-lg font-bold mt-8 mb-2">{prop.address}</h3>
                                  <p className="text-sm text-gray-600 mb-4">Week of {formatWeekRange(prop.weekOf)}</p>
                                  
                                  {isBooked ? (
                                    <div className="bg-gray-100 rounded-lg p-4 text-sm">
                                      <p className="font-bold mb-1">{booking.agentName}</p>
                                      <p>{formatDate(booking.date)}</p>
                                      <p>{formatTime(booking.startTime)} - {formatTime(booking.endTime)}</p>
                                    </div>
                                  ) : (
                                    <button onClick={() => handleStartBooking(prop)} className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold">
                                      Reserve
                                    </button>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {view === 'admin' && !isAdminAuthenticated && (
                  <div className="bg-white rounded-xl shadow-xl p-8 max-w-md mx-auto">
                    <h2 className="text-2xl font-bold mb-6 text-center">Admin Login</h2>
                    <input
                      type="password"
                      value={adminPassword}
                      onChange={(e) => setAdminPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                      placeholder="Password"
                      className="w-full px-4 py-3 border-2 rounded-lg mb-4"
                    />
                    <button onClick={handleAdminLogin} className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold">
                      Login
                    </button>
                  </div>
                )}

                {view === 'admin' && isAdminAuthenticated && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-xl shadow-xl p-8">
                      <h2 className="text-2xl font-bold mb-6">Add New Property</h2>
                      <div className="space-y-4">
                        <input
                          type="text"
                          placeholder="Property Address"
                          value={newProperty.address}
                          onChange={(e) => setNewProperty({...newProperty, address: e.target.value})}
                          className="w-full px-4 py-3 border-2 rounded-lg"
                        />
                        <input
                          type="date"
                          value={newProperty.weekOf}
                          onChange={(e) => setNewProperty({...newProperty, weekOf: e.target.value})}
                          className="w-full px-4 py-3 border-2 rounded-lg"
                        />
                        <p className="text-sm text-gray-500">Select a Monday</p>
                        <button onClick={handleAddProperty} className="bg-blue-900 text-white px-8 py-3 rounded-lg font-bold">
                          Add Property
                        </button>
                      </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-xl p-8">
                      <h2 className="text-2xl font-bold mb-6">All Properties</h2>
                      {activeProperties.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">No properties</p>
                      ) : (
                        <div className="space-y-4">
                          {activeProperties.map((prop, idx) => {
                            const booking = getBookingForProperty(prop.address, prop.weekOf);
                            return (
                              <div key={idx} className="border-2 rounded-xl p-6">
                                <div className="flex justify-between items-start">
                                  <div>
                                    <h3 className="font-bold text-lg">{prop.address}</h3>
                                    <p className="text-sm text-gray-600">Week of {formatWeekRange(prop.weekOf)}</p>
                                  </div>
                                  <button onClick={() => handleDeleteProperty(prop.address, prop.weekOf)} className="text-red-600 text-xl">
                                    âœ•
                                  </button>
                                </div>
                                {booking && (
                                  <div className="mt-4 bg-gray-50 p-4 rounded-lg">
                                    <p className="font-bold">{booking.agentName}</p>
                                    <p className="text-sm">{booking.phone}</p>
                                    <p className="text-sm">{formatDate(booking.date)}</p>
                                    <p className="text-sm">{formatTime(booking.startTime)} - {formatTime(booking.endTime)}</p>
                                    <button onClick={() => handleCancelBooking(booking.propertyAddress, booking.weekOf)} className="mt-2 text-red-600 text-sm font-semibold">
                                      Cancel Booking
                                    </button>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<OpenHouseScheduler />);
    </script>
</body>
</html>
